<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P WebRTC Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .chat-container { background: rgba(255,255,255,0.95); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .chat-messages { height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; }
    .message { margin: 8px; padding: 10px 15px; border-radius: 18px; max-width: 80%; word-wrap: break-word; }
    .message.sent { background: #007bff; color: white; margin-left: auto; }
    .message.received { background: #e9ecef; color: #333; }
    .message.system { background: #ffc107; color: #333; text-align: center; margin: 10px auto; }
    .connection-status { font-size: 0.9em; }
    .status-connected { color: #28a745; }
    .status-disconnected { color: #dc3545; }
    .status-connecting { color: #ffc107; }
    .description-box { font-family: monospace; font-size: 0.8em; }
    .btn-copy { position: absolute; top: 5px; right: 5px; }
    .description-container { position: relative; }
    .flow-step { display: none; }
    .flow-step.active { display: block; }
    .invite-link { word-break: break-all; background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="chat-container p-4">
          <!-- Header -->
          <div class="text-center mb-4">
            <h2 class="text-primary">
              <i class="bi bi-chat-dots"></i> P2P WebRTC Chat
            </h2>
            <p class="text-muted">Peer-to-peer chat without any central server</p>
          </div>

          <!-- Step 1: Initial State - Create Chat Invite -->
          <div id="step-initial" class="flow-step active">
            <div class="text-center">
              <div class="mb-4">
                <i class="bi bi-plus-circle" style="font-size: 4rem; color: #007bff;"></i>
              </div>
              <h4>Start a New Chat</h4>
              <p class="text-muted mb-4">Create an invite link to share with someone and start chatting peer-to-peer.</p>
              <button id="create-invite" class="btn btn-primary btn-lg">
                <i class="bi bi-link-45deg"></i> Create Chat Invite Link
              </button>
            </div>
          </div>

          <!-- Step 2: Offerer State - Waiting for Response -->
          <div id="step-offerer" class="flow-step">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-share"></i> Share Your Invite Link</h5>
              </div>
              <div class="card-body">
                <p class="text-muted mb-3">Share this link with the person you want to chat with:</p>
                <div class="invite-link mb-3" id="invite-link-display"></div>
                <div class="d-flex gap-2 mb-4">
                  <button id="copy-invite-link" class="btn btn-outline-primary">
                    <i class="bi bi-clipboard"></i> Copy Link
                  </button>
                  <button id="new-invite" class="btn btn-outline-secondary">
                    <i class="bi bi-plus-circle"></i> Create New Invite
                  </button>
                </div>
                
                <hr>
                
                <h6 class="mb-3"><i class="bi bi-arrow-down-circle"></i> Wait for Response</h6>
                <p class="text-muted mb-3">Once your peer accepts the invite, they'll send you a response. Paste it here:</p>
                <div class="mb-3">
                  <textarea id="offerer-response" class="form-control" rows="4" placeholder="Paste your peer's response here..."></textarea>
                </div>
                <button id="offerer-connect" class="btn btn-success">
                  <i class="bi bi-wifi"></i> Connect & Start Chat
                </button>
              </div>
            </div>
          </div>

          <!-- Step 3: Accepter State - Accept Invite -->
          <div id="step-accepter" class="flow-step">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-envelope-open"></i> Chat Invitation</h5>
              </div>
              <div class="card-body">
                <p class="text-muted mb-3">You've been invited to join a peer-to-peer chat!</p>
                <button id="accept-invite" class="btn btn-success btn-lg mb-4">
                  <i class="bi bi-check-circle"></i> Accept Chat Invite
                </button>
                
                <div id="accepter-response-section" style="display: none;">
                  <hr>
                  <h6 class="mb-3"><i class="bi bi-arrow-up-circle"></i> Send Response Back</h6>
                  <p class="text-muted mb-3">Copy this response and send it back to the person who invited you:</p>
                  <div class="description-container mb-3">
                    <textarea id="accepter-response" class="form-control description-box" rows="4" readonly></textarea>
                    <button id="copy-accepter-response" class="btn btn-sm btn-outline-secondary btn-copy">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Important:</strong> Send this response back to the person who invited you. Once they use it, the chat will begin!
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4: Chat Interface -->
          <div id="step-chat" class="flow-step">
            <!-- Connection Status -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="connection-status">
                    <span id="status-text" class="status-disconnected">
                      <i class="bi bi-circle-fill"></i> Disconnected
                    </span>
                  </div>
                  <button id="new-chat" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-plus-circle"></i> New Chat
                  </button>
                </div>
              </div>
            </div>

            <!-- Chat Area -->
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-chat"></i> Chat</h5>
              </div>
              <div class="card-body">
                <div id="chat" class="chat-messages p-3 mb-3"></div>
                <div class="input-group">
                  <input id="message" type="text" class="form-control" placeholder="Type a message..." disabled>
                  <button id="send" class="btn btn-primary" disabled>
                    <i class="bi bi-send"></i> Send
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let pc, channel;
    let currentOffer = null;
    
    // DOM elements
    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const statusText = document.getElementById('status-text');
    
    // Flow step elements
    const stepInitial = document.getElementById('step-initial');
    const stepOfferer = document.getElementById('step-offerer');
    const stepAccepter = document.getElementById('step-accepter');
    const stepChat = document.getElementById('step-chat');
    
    // Offerer elements
    const inviteLinkDisplay = document.getElementById('invite-link-display');
    const copyInviteLinkBtn = document.getElementById('copy-invite-link');
    const newInviteBtn = document.getElementById('new-invite');
    const offererResponse = document.getElementById('offerer-response');
    const offererConnectBtn = document.getElementById('offerer-connect');
    
    // Accepter elements
    const acceptInviteBtn = document.getElementById('accept-invite');
    const accepterResponseSection = document.getElementById('accepter-response-section');
    const accepterResponse = document.getElementById('accepter-response');
    const copyAccepterResponseBtn = document.getElementById('copy-accepter-response');
    const newChatBtn = document.getElementById('new-chat');

    function showStep(stepId) {
      // Hide all steps
      document.querySelectorAll('.flow-step').forEach(step => step.classList.remove('active'));
      // Show the specified step
      document.getElementById(stepId).classList.add('active');
    }

    function updateStatus(status, className) {
      statusText.className = `status-${className}`;
      statusText.innerHTML = `<i class="bi bi-circle-fill"></i> ${status}`;
    }

    function log(msg, type = 'system') {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.textContent = msg;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function enableChat() {
      messageInput.disabled = false;
      sendBtn.disabled = false;
      updateStatus('Connected', 'connected');
    }

    function disableChat() {
      messageInput.disabled = true;
      sendBtn.disabled = true;
      updateStatus('Disconnected', 'disconnected');
    }

    function setupChannelEvents() {
      channel.onopen = () => {
        log('Connected! You can now chat.', 'system');
        enableChat();
        // Both offerer and accepter should transition to chat interface
        showStep('step-chat');
      };
      channel.onmessage = e => {
        log(e.data, 'received');
      };
      channel.onclose = () => {
        log('Connection closed', 'system');
        disableChat();
      };
    }

    function generateInviteUrl(offerData) {
      const baseUrl = window.location.origin + window.location.pathname;
      const jsonString = JSON.stringify(offerData);
      const base64Data = btoa(jsonString);
      const encodedOffer = encodeURIComponent(base64Data);
      return `${baseUrl}?invite=${encodedOffer}`;
    }

    function parseInviteFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const inviteParam = urlParams.get('invite');
      if (inviteParam) {
        try {
          const base64Data = decodeURIComponent(inviteParam);
          const jsonString = atob(base64Data);
          return JSON.parse(jsonString);
        } catch (e) {
          console.error('Invalid invite data:', e);
          return null;
        }
      }
      return null;
    }

    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    // Initialize based on URL
    function initializeApp() {
      const inviteData = parseInviteFromUrl();
      if (inviteData) {
        // User accessed via invite link - show accepter interface
        currentOffer = inviteData;
        showStep('step-accepter');
      } else {
        // User accessed normally - show initial interface
        showStep('step-initial');
      }
    }

    // Event Listeners
    document.getElementById('create-invite').onclick = async () => {
      updateStatus('Creating invite...', 'connecting');
      
      pc = new RTCPeerConnection();
      channel = pc.createDataChannel('chat');
      setupChannelEvents();
      
      pc.onicecandidate = e => {
        if (e.candidate === null) {
          const offerData = pc.localDescription;
          const inviteUrl = generateInviteUrl(offerData);
          inviteLinkDisplay.textContent = inviteUrl;
          showStep('step-offerer');
        }
      };
      
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    };

    copyInviteLinkBtn.onclick = () => {
      copyToClipboard(inviteLinkDisplay.textContent, copyInviteLinkBtn);
    };

    newInviteBtn.onclick = () => {
      showStep('step-initial');
      currentOffer = null;
      pc = null;
      channel = null;
    };

    acceptInviteBtn.onclick = async () => {
      if (!currentOffer) {
        alert('No invite data found!');
        return;
      }

      updateStatus('Accepting invite...', 'connecting');
      
      pc = new RTCPeerConnection();
      pc.ondatachannel = e => {
        channel = e.channel;
        setupChannelEvents();
      };
      
      pc.onicecandidate = e => {
        if (e.candidate === null) {
          const answerData = pc.localDescription;
          accepterResponse.value = JSON.stringify(answerData);
          accepterResponseSection.style.display = 'block';
        }
      };
      
      try {
        await pc.setRemoteDescription(currentOffer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
      } catch (err) {
        log('Error accepting invite: ' + err.message, 'system');
        updateStatus('Error', 'disconnected');
      }
    };

    copyAccepterResponseBtn.onclick = () => {
      copyToClipboard(accepterResponse.value, copyAccepterResponseBtn);
    };

    offererConnectBtn.onclick = async () => {
      if (!pc) {
        alert('No active connection!');
        return;
      }

      try {
        updateStatus('Connecting...', 'connecting');
        const responseData = JSON.parse(offererResponse.value);
        await pc.setRemoteDescription(responseData);
        showStep('step-chat');
        log('Connection established!', 'system');
      } catch (err) {
        log('Error connecting: ' + err.message, 'system');
        updateStatus('Error', 'disconnected');
      }
    };

    sendBtn.onclick = () => {
      const msg = messageInput.value.trim();
      if (msg && channel && channel.readyState === 'open') {
        channel.send(msg);
        log(msg, 'sent');
        messageInput.value = '';
      }
    };

    messageInput.onkeydown = e => {
      if (e.key === 'Enter') sendBtn.onclick();
    };

    newChatBtn.onclick = () => {
      showStep('step-initial');
      currentOffer = null;
      pc = null;
      channel = null;
      chat.innerHTML = '';
      disableChat();
    };

    // Initialize the app
    initializeApp();
    disableChat();
  </script>
</body>
</html> 